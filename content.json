[{"title":"尝试自己编写一个js-sdk","date":"2017-01-05T12:26:00.000Z","path":"2017/01/05/write-my-js-sdk/","text":"","tags":[{"name":"nw","slug":"nw","permalink":"http://liuwf2012.github.io/tags/nw/"},{"name":"js","slug":"js","permalink":"http://liuwf2012.github.io/tags/js/"}]},{"title":"angular实现的userAvatar指令","date":"2016-11-23T10:40:00.000Z","path":"2016/11/23/ng-avatar-directive/","text":"近来手头负责的项目进入收尾阶段，开始做系统测试，于是乎有时间整理下原来就觉得可以优化的点。其中一个比较在意的，就是用户头像。 吐槽通常一个系统的默认头像是如何处理的呢？基本就是准备一张默认图片，当用户未设置头像时，则全部显示默认图片，比如我们最常见的他 单看挺好，放在系统右上角显示用户头像也没什么，但一旦进入用户列表时，就有些不淡定了 感觉就像看完《代号D机关》，有种脸盲症的恐慌。平时用一些其他saas产品时，经常会有些花花绿绿的默认头像，而且可以默认用用户名做头像，识别度高，体验相当不错。比如下面这几个： 就决定是你了！ 需求整理由于项目前端使用AngularJs，所以最方便的就是编写一个directive来作为通用的用户头像组件。先捋下这个userAvatar指令应该要有哪些东西： 用户未设置头像，则截取用户名作为头像 用户已设置头像，则直接显示用户头像 默认头像应具备多种颜色 头像提供多种尺寸 提供头像点击的事件 参数变化时，更新头像 代码实现先上完整代码（样式在css文件中）： 关于实现代码的几点说明： 1.头像的DOM节点头像节点分两种，有用户头像时直接将图片作为background显示，没有则在根节点下生成一个div用于显示用户名，由函数createAvatar生成（代码第50-66行）1234567//设置头像&lt;div class=&quot;user-avatar&quot; style=&quot;background-image:url(http://xxxx.png)&quot;&gt;&lt;/div&gt;//为未设置头像&lt;div class=&quot;user-avatar&quot;&gt; &lt;div class=&quot;avatar-text&quot;&gt;用户别名&lt;/div&gt;&lt;/div&gt; 2.用户别名由于头像是圆形，放两个文字显示效果最佳，故对用户名进行截取，获取用户别名（代码第43-49行）。具体规则： 1） 中文用户名就取后两位（既有中文，又有英文就按中文名计算） 2） 英文用户名就取前两位 3.用户名头像的背景颜色最初的实现是使用random()在colors数组中获取随机颜色，但会导致同一个用户的头像颜色每次都不一样，显然不是很舒服。于是，改为使用用户别名的unicode码取模来计算颜色，这样同一个用户名每次计算出的背景色都一样（代码第37-42行） 4.头像点击事件大多数情况下，系统中的头像都能点击，呼出用户详情的弹窗，所以指令中的on-click-avatar属性用于提供事件回调 5.用户数据修改后的头像更新这可以分成两种情况：1）指令绑定的数据被更新2）指令同时在多个地方使用，并绑定了同一个用户数据的不同Model，其中一个Model被更新举个例子来说明这两种情况：现在有user1和user1_copy两个对象，他们数据一样，是同一个scope下的两个model（测试代码） 当点击第一个按钮，user1的数据会被更新，此时由于指令内部我们添加了$watch（代码第67-72行），所以user1的头像被更新了。这就是第一种情况。 然而，对于user1_copy，他是检测不到user1的变化的，他就不会被更新，这就是上面说的第二种情况。对应到真实业务流程中常见的一种场景，用户在账户信息页修改头像，成功后账户信息页里的头像被刷新了，但是页面顶部栏里的用户登录头像应该也要同步刷新。为了满足这类场景，我们使用angular的消息机制$broadcast和$on，来实现user1更新时user1_copy也更新（代码第81-92行）。 6.指令的使用 1&lt;user-avatar uid=&quot;12121&quot; user-name=&quot;XXX&quot; avatar=&quot;http://a.jpg&quot; size=&quot;lg&quot; on-click-avatar=&quot;fn()&quot;&gt;&lt;/user-avatar&gt; 源码 牢骚话作为一个非全职前端（偶尔得写写java和C#），我始终觉得前端开发是个细致活。在后端同学看来头像就是开头那张灰溜溜的图片嘛，但作为前端同学，我们始终应该追求 better than better。","tags":[{"name":"Angular","slug":"Angular","permalink":"http://liuwf2012.github.io/tags/Angular/"}]}]